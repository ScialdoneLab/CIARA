---
title: "CIARA_main_figures"
author: "Gabriele Lubatti"
date: "7/4/2022"
output: html_document
---



```{r }
gc()
rm(list=ls())
```


```{r } 
#devtools::install_github("ScialdoneLab/CIARA",auth_token="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",ref="master")
```



```{r }
library(CIARA)
library(Seurat)
library(gplots)
library(ggplot2)
library("mltools")
library(FiRE)
library(clustree)
library(CellSIUS)
library(RaceID)
library(singleCellHaystack)
```

## Function
```{r }
find_positive_cells=function(norm_elmir_5_30,geni_marker,threshold){

logic_cell=apply(norm_elmir_5_30[geni_marker,],2,function(x){
  
  if (sum(x>threshold)==length(x))
  {return(TRUE)}
  else{return(FALSE)}
})
positive_cells=colnames(norm_elmir_5_30)[logic_cell]
return(positive_cells)
}



```

```{r}
Test_Fisher=function(entropy_cluster,markers_cluster,marker_top,background){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
set_1=marker_top
for (i in 1:length(level)){
  set_2=markers_cluster[names(markers_cluster)==level[i]]
set_all=background
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}
```

```{r }
Function_fisher=function(a,b,c){
matrice=matrix(c(sum(c[c%in%a]%in%c[c%in%b]),sum(c[c%in%a]%in%c[!c%in%b]),sum(c[!c%in%a]%in%c[c%in%b]),sum(c[!c%in%a]%in%c[!c%in%b])),nrow=2,ncol=2,byrow = T)
#Fisher test
fisher.test(matrice)
}
```

```{r }
Get_background=function(norm_matrix,min_cells,min_counts){
genes_filter=apply(norm_matrix,1,function(x){
x=x[x>min_counts]
if (length(x)>min_cells){return(TRUE)}
else{return(FALSE)}
})
genes_important=row.names(norm_matrix)[genes_filter]
return(genes_important)}
```

```{r}
Cluster_analysis_integrate_rare_update=function (raw_counts, batch_name_1, resolution, neighbors, max_dimension, 
    feature_genes = NULL) 
{
    batch_1 <- CreateSeuratObject(counts = raw_counts, project = batch_name_1)
    batch_1 <- subset(batch_1, subset = nFeature_RNA > 0)
    batch_1 <- NormalizeData(batch_1, verbose = FALSE)
    batch_1 <- FindVariableFeatures(batch_1, selection.method = "vst", 
        nfeatures = 2000)
    batch_combined = batch_1
    #batch_combined <- ScaleData(batch_combined, verbose = FALSE)
    batch_combined$frac_mito=frac_mito
batch_combined$frac_ribo=frac_ribo
batch_combined <- ScaleData(batch_combined, verbose = FALSE,vars.to.regress = c("nCount_RNA","frac_mito","frac_ribo"))
    batch_combined <- RunPCA(batch_combined, npcs = max_dimension, 
        verbose = FALSE, features = feature_genes)
    batch_combined = RunUMAP(batch_combined, reduction = "pca", 
        dims = 1:20, set.seed = 42)
    batch_combined <- FindNeighbors(batch_combined, reduction = "pca", 
        dims = 1:max_dimension, k.param = neighbors)
    batch_combined <- FindClusters(batch_combined, resolution = resolution)
    return(batch_combined)
}
```

## Download files
```{r}
current_wd <- getwd()
url="https://hmgubox2.helmholtz-muenchen.de/index.php/s/x83jDLHobM7Qer6/download/CIARA.zip"

destfile <- paste0(current_wd,"/CIARA.zip")
download.file(url, destfile, quiet = FALSE)
unzip(destfile, exdir=current_wd)
```

```{r }
setwd(paste0(current_wd,"/CIARA"))
load(file='mayra_dati_raw_0.Rda')
mayra_seurat_0=cluster_analysis_integrate_rare(mayra_dati_raw_0,"Mayra_data_0",0.1,5,30)
norm_counts_ane_0=as.matrix(GetAssayData(mayra_seurat_0, slot = "data",assay="RNA"))
knn_matrix_ane_0=as.matrix(mayra_seurat_0@graphs$RNA_nn)
cordinate_umap_0=as.data.frame(Embeddings(mayra_seurat_0, reduction = "umap")[, 1:2])
```

## Run CIARA
```{r }
#norm_matrix=norm_counts_ane_0
#knn_matrix=knn_matrix_ane_0
#background <- get_background_full(norm_matrix, threshold = 1, n_cells_low = 3, n_cells_high = 20)
#result <- CIARA(norm_matrix, knn_matrix, background, cores_number = 1, p_value = 0.001, local_region = 1, approximation = FALSE)

setwd(paste0(current_wd,"/CIARA"))
load("result_ane_0.Rda")
```



```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```

## Figure 1b
```{r }
localized_genes_mouse=detect_localized_genes(knn_matrix_ane_0,norm_counts_ane_0,geni_top_top,100) 
rank_intersect=localized_genes_mouse[[2]]
list_intersect=localized_genes_mouse[[1]]

ramp <- colorRamp(c("white", "blue4"))




ramp <- colorRamp(c("white", "blue4"))
 

rank_intersect=localized_genes_mouse[[2]]
list_intersect=localized_genes_mouse[[1]]


ramp.list <- rgb( ramp(seq(0, 1, length = length(unique(rank_intersect)))), max = 255)

index_color=round(length(ramp.list)/2,0)


breaks = seq(0,max(rank_intersect),length.out=1000)
gradient1 = colorpanel( sum( breaks[-1]<= as.numeric(quantile(breaks,0.25))), "#FFFFFF",ramp.list[index_color])

gradient2 = colorpanel( sum( breaks[-1] > as.numeric(quantile(breaks,0.25)) ), ramp.list[index_color], "#00008B" )


hm.colors = c(gradient1,gradient2)
 





genes_name_text=names_localized_genes(list_intersect ,geni_top_top,max_number=5)


plot_localized_genes_interactive(cordinate_umap_0,norm_counts_ane_0,rank_intersect,genes_name_text,hm.colors,min_x=NULL,max_x=NULL,min_y=NULL,max_y=NULL)



plot_localized_genes(cordinate_umap_0,norm_counts_ane_0,rank_intersect,"Top 100 genes CIARA",hm.colors)+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+theme(text = element_text(size=12))+geom_point( alpha = 0.3, na.rm = T, shape = 21, colour = "black",stroke=0.1)







```
```{r }
mayra_0_ciara=cluster_analysis_integrate_rare(mayra_dati_raw_0,"Mayra data",0.1,5,30,ciara_genes)


```


## Figure 1C
```{r }
mayra_0_ciara=FindClusters(mayra_0_ciara,resolution = 0.1)
p=plot_umap(cordinate_umap_0,as.vector(mayra_0_ciara$RNA_snn_res.0.1))
p[[1]]+theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+theme(text = element_text(size=18))


```




## Figure 2b

### FiRE

```{r }
setwd(paste0(current_wd,"/CIARA"))
load(file="data.Rda")
setwd(paste0(current_wd,"/CIARA"))
labels <- read.table('/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/FiRE-master/data/labels_jurkat_two_species_1580.txt')
labels=labels$V1
```




```{r }
setwd(paste0(current_wd,"/CIARA"))
load("fire.Rda")
```


```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```

```{r }
fire_ciara=cluster_analysis_integrate_rare(data,"24h",0.1,3,30,ciara_genes)
```

```{r }

norm_fire_ciara=as.matrix(GetAssayData(fire_ciara, slot = "data",assay="RNA"))
cluster_fire_ciara=as.vector(fire_ciara$RNA_snn_res.0.1)

```



```{r }
setwd(paste0(current_wd,"/CIARA"))
source("preprocess.R")

data_example <- t(data)
genes <- colnames(data_example)

data_mat <- list(mat=data_example, gene_symbols=genes)

preprocessedList <- ranger_preprocess(data_mat)
preprocessedData <- as.matrix(preprocessedList$preprocessedData)

model <- new(FiRE::FiRE, 100, 50, 1017881, 5489, 0)

model$fit(preprocessedData)

score <- model$score(preprocessedData)
q3 <- quantile(score, 0.75)
iqr <- IQR(score)
th <- q3 + (1.5*iqr)
indIqr <- which(score >= th)
predictions <- integer(dim(data_example)[1])
predictions[indIqr] <- 1 


```

```{r }

#mcc()
#Matthews correlation coefficient 

preds=as.numeric(cluster_fire_ciara)
actuals=as.numeric(labels)
actuals_new=actuals
actuals_new[actuals==2]=1
actuals_new[actuals==1]=0


mcc(preds, actuals_new)



mcc(predictions, actuals_new)
```




```{r }

method=factor(c("CIARA","FiRE"),levels=c(c("CIARA","FiRE")))
df=data.frame(c(0.95,0.74),method)
colnames(df)=c("MCC","Method")
ggplot(data=df, aes(x=Method, y=MCC, fill=Method)) +
  geom_bar(stat="identity", width=0.5)+ylim(0,1)+ggtitle("MCC score")+scale_fill_manual(values=c(CIARA:::gg_color_hue(2)))

```


## CellSIUS

```{r }
setwd(paste0(current_wd,"/CIARA"))
load(file="raw_sce_small.Rda")
load(file="cell_line_all.Rda")

```


```{r }
setwd(paste0(current_wd,"/CIARA"))
load("cellsius.Rda")
```



```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```


```{r }

cellsius_ciara=cluster_analysis_integrate_rare(raw_sce_small,"24h",0.1,3,30,(ciara_genes))


```




```{r }
norm_cellsius_ciara=as.matrix(GetAssayData(cellsius_ciara, slot = "data",assay="RNA"))
cluster_cellsius_ciara=as.vector(cellsius_ciara$RNA_snn_res.0.1)
```


```{r }

#mcc()
#Matthews correlation coefficient 

preds=as.numeric(cluster_cellsius_ciara)[cluster_cellsius_ciara==7|cluster_cellsius_ciara==8]
actuals=as.numeric(cell_line_all)[cluster_cellsius_ciara==7|cluster_cellsius_ciara==8]

actuals_new=actuals
actuals_new[actuals==8]=7
actuals_new[actuals==5]=8

mcc(preds, actuals_new)





```
```{r }
method=factor(c("CIARA","CellSIUS"),levels=c(c("CIARA","CellSIUS")))
df=data.frame(c(1,1),method)
colnames(df)=c("MCC","Method")
ggplot(data=df, aes(x=Method, y=MCC, fill=Method)) +
  geom_bar(stat="identity", width=0.5)+ylim(0,1)+ggtitle("MCC score")+scale_fill_manual(values=c(CIARA:::gg_color_hue(2)))

```

## GiniClust

```{r }
setwd(paste0(current_wd,"/CIARA"))
load("gini_fig_5.Rda")
```




```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```



```{r }
setwd(paste0(current_wd,"/CIARA"))
load("test_data_3.Rda")
#load(file="norm_gini_3.Rda")
#load(file="knn_matrix_gini_5_30_3.Rda")
#load(file="cordinate_gini_3.Rda")
setwd(paste0(current_wd,"/CIARA"))
gini_cluster_3=read.csv2("13059_2016_1010_MOESM11_ESM.csv")

gini_name_3=gini_cluster_3$Cell.ID
gini_cluster_3=gini_cluster_3$Cluster.ID
ordine=data.frame(gini_name_3,gini_cluster_3)
row.names(ordine)=gini_name_3
gini_cluster_3=ordine[colnames(test_data_3),2]
```

```{r }
gini_ciara=cluster_analysis_integrate_rare(test_data_3,"24h",0.1,3,30,ciara_genes)
```


```{r }

norm_gini_ciara=as.matrix(GetAssayData(gini_ciara, slot = "data",assay="RNA"))

cluster_gini_ciara=as.vector(gini_ciara$RNA_snn_res.0.1)

```


```{r }
geni_marker=c("CLDN11","MBP","PLP1","KLK6")
positive_cells=find_positive_cells(norm_gini_ciara,geni_marker,threshold = 0)
```




```{r }

ciara_score=rep(0,length(gini_cluster_3))
method_score=rep(0,length(gini_cluster_3))
original_score=rep(0,length(gini_cluster_3))

method_score[gini_cluster_3=="Cluster_3"]=1
ciara_score[as.vector(gini_ciara$RNA_snn_res.0.1)==10]=1
original_score[colnames(norm_gini_ciara)%in%positive_cells]=1


mcc(ciara_score, original_score)

mcc(method_score, original_score)


```

```{r }
library(ggplot2)
library(CIARA)
method=factor(c("CIARA","GiniClust"),levels=c(c("CIARA","GiniClust")))
df=data.frame(c(0.74,0.66),method)
colnames(df)=c("MCC","Method")

ggplot(data=df, aes(x=Method, y=MCC, fill=Method)) +
  geom_bar(stat="identity", width=0.5)+ylim(0,1)+ggtitle("MCC score")+scale_fill_manual(values=c(CIARA:::gg_color_hue(2)))

```

## GiniClust2

```{r }
setwd(paste0(current_wd,"/CIARA"))
load("finalCluster.Rda")
load("giniclust2.Rda")


raw_gini2=(GetAssayData(giniclust2, slot = "data",assay="RNA"))

```

```{r }
setwd(paste0(current_wd,"/CIARA"))
load("gini2.Rda")
```


```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```

```{r }
giniclu2_ciara=cluster_analysis_integrate_rare(raw_gini2,"24h",0.3,5,30,ciara_genes)

cluster_gini2_ciara=as.vector(giniclu2_ciara$RNA_snn_res.0.3)
```


```{r }
norm_gini2=as.matrix(GetAssayData(giniclu2_ciara, slot = "data",assay="RNA"))

geni_marker_1=c("Col4a1","Col4a2","Lama1","Ctsl")

geni_marker_2=c("Rhox6","Rhox9","Sct")
positive_cells_1=find_positive_cells(norm_gini2,geni_marker_1,threshold = 0)
positive_cells_2=find_positive_cells(norm_gini2,geni_marker_2,threshold = 0)

```







```{r }


method_score=rep(0,length(colnames(norm_gini2)))
ciara_score=rep(0,length(colnames(norm_gini2)))
original_score=rep(0,length(colnames(norm_gini2)))
original_score[colnames(norm_gini2)%in%positive_cells_1]=1
method_score[finalCluster==1]=1
ciara_score[cluster_gini2_ciara==2]=1

mcc(ciara_score,original_score)


mcc(method_score,original_score)




method_score=rep(0,length(colnames(norm_gini2)))
ciara_score=rep(0,length(colnames(norm_gini2)))
original_score=rep(0,length(colnames(norm_gini2)))
original_score[colnames(norm_gini2)%in%positive_cells_2]=1
method_score[finalCluster==2]=1
ciara_score[cluster_gini2_ciara==1]=1

mcc(ciara_score,original_score)


mcc(method_score,original_score)


```
```{r }
library(ggplot2)
library(CIARA)
method=factor(c("CIARA","GiniClust2"),levels=c(c("CIARA","GiniClust2")))
df=data.frame(c(0.7398754,0.7398754),method)
colnames(df)=c("MCC","Method")
ggplot(data=df, aes(x=Method, y=MCC, fill=Method)) +
  geom_bar(stat="identity", width=0.5)+ylim(0,1)+ggtitle("MCC score")+scale_fill_manual(values=c(CIARA:::gg_color_hue(2)))

```

```{r }
library(ggplot2)
library(CIARA)
method=factor(c("CIARA","GiniClust2"),levels=c(c("CIARA","GiniClust2")))
df=data.frame(c(0.8911083,0.7019264),method)
colnames(df)=c("MCC","Method")

ggplot(data=df, aes(x=Method, y=MCC, fill=Method)) +
  geom_bar(stat="identity", width=0.5)+ylim(0,1)+ggtitle("MCC score")+scale_fill_manual(values=c(CIARA:::gg_color_hue(2)))

```

## RaceID 

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data")
load(file="race_id_raw.Rda")
load(file="cluster_race_id.Rda")
load(file="cordinate_race.Rda")

```


```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
load("race.Rda")
```


```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```

```{r }

race_ciara=cluster_analysis_integrate_rare(race_id_raw,"24h",0.2,3,20,ciara_genes)

```

```{r }

norm_race=as.matrix(GetAssayData(race_ciara, slot = "data",assay="RNA"))

cluster_race_ciara=as.vector(race_ciara$RNA_snn_res.0.2)

```

```{r }
p=plot_umap(cordinate_race,cluster_race_id)
p[[1]]+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(text = element_text(size=18))
  
```

```{r }
p=plot_umap(cordinate_race,cluster_race_ciara)
p[[1]]+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(text = element_text(size=18))

```

```{r}
DefaultAssay(race_ciara) <- "RNA"
markers_race_ciara=markers_cluster_seurat(race_ciara,as.vector(race_ciara$RNA_snn_res.0.2),names(race_ciara$RNA_snn_res.0.2),5)
```

```{r}

marker_all_day_24_first=markers_race_ciara[[3]]



```

### Cluster 2 is Goblet cells

```{r}
marker_all_day_24_first[marker_all_day_24_first=="Clca3"]
```


### Cluster 3 is enterocytes
```{r}
marker_all_day_24_first[marker_all_day_24_first=="Apoa1"]
```

### Cluster 4 is Paneth cells
```{r}
marker_all_day_24_first[marker_all_day_24_first=="Defa24"]
```

### Cluster 5 is enteroendocrine cells


```{r}
marker_all_day_24_first[marker_all_day_24_first=="Chgb"]
```


### Cluster 7 is tuft cells 

```{r}
marker_all_day_24_first[marker_all_day_24_first=="Dclk1"]
marker_all_day_24_first[marker_all_day_24_first=="Lrmp"]
marker_all_day_24_first[marker_all_day_24_first=="Trpm5"]
```
### Cluster 6:markers other unkonwn cell types
```{r}
marker_all_day_24_first[marker_all_day_24_first=="Nol3"]
marker_all_day_24_first[marker_all_day_24_first=="Mylk4"]
```


## Figure 2C
```{r }
setwd(paste0(current_wd,"/CIARA"))
load(file = "raw_counts_human_data.Rda")
load(system.file("extdata", "result.Rda", package = "CIARA"))
ciara_genes <- row.names(result)[result[, 1] < 1]
ciara_genes_top <- row.names(result)[order(as.numeric(result[, 1]))]
background=row.names(result)
meta_info <- readRDS(system.file("extdata", "annot_umap.rds", package ="CIARA"))
coordinate_umap <- meta_info[,2:3]

```

```{r }
elmir_seurat_ciara=cluster_analysis_integrate_rare(raw_counts_human_data,"Elmir data",0.01,5,30,ciara_genes)

```




```{r }

norm_elmir_ciara_5_30=as.matrix(GetAssayData(elmir_seurat_ciara, slot = "data",assay="RNA"))

```


```{r}
original_cluster=as.vector(meta_info$cluster_id)
names(original_cluster)=names(elmir_seurat_ciara$RNA_snn_res.0.01)
final_cluster=merge_cluster(original_cluster,elmir_seurat_ciara$RNA_snn_res.0.01,20)
```


```{r}
final_cluster[final_cluster=="2-step_2"]="PGC"
```


```{r}
new_cluster=rep("Other Clusters",length(final_cluster))
new_cluster[final_cluster=="PGC"]="PGC"
p=plot_umap(coordinate_umap,new_cluster)

p[[1]]+scale_color_manual(values=c("grey","black"))+theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+theme(text = element_text(size=18))

```


###Step 3



```{r }
result_test <- test_hvg(raw_counts_human_data,final_cluster, ciara_genes, background, number_hvg = 100, min_p_value = 0.001)
result_test[[2]]

```









```{r }
raw_endoderm=raw_counts_human_data[,as.vector(meta_info$cluster_id)=="Endoderm"]
raw_emo=raw_counts_human_data[,as.vector(meta_info$cluster_id)=="Hemogenic Endothelial Progenitors"]



combined_endoderm=cluster_analysis_sub(raw_endoderm,0.2,5,30,"Endoderm")

combined_emo=cluster_analysis_sub(raw_emo,0.6,5,30,"Hemogenic Endothelial Progenitors")






```




```{r }

all_sub_cluster=c(combined_endoderm$seurat_clusters,combined_emo$seurat_clusters)
final_cluster_version_sub=merge_cluster(final_cluster,all_sub_cluster)
```

```{r }


original_sub=as.vector(meta_info$sub_cluster)
original_sub[original_sub=="Blood Progenitors"]="MEP"
original_sub[grep("Hemogenic Endothelial Progenitors_4",final_cluster_version_sub)]="MEP1"
original_sub[original_sub=="YS Endoderm"]="YSE"
original_sub[original_sub=="Hypoblast"]="Hypo"
original_sub[grep("Endoderm_2",final_cluster_version_sub)]="YSE1"
original_sub[original_sub=="DE(P)"]="DE1"
original_sub[original_sub=="DE(NP)"]="DE2"
original_sub[original_sub=="Erythroblasts"]="Ery"
original_sub[original_sub=="Erythro-Myeloid Progenitors"]="EMP"
original_sub[original_sub=="Hemogenic Endothelium"]="HE"
original_sub[original_sub=="Myeloid Progenitors"]="MP"
```


```{r}
DefaultAssay(elmir_seurat_ciara) <- "RNA"
markers_first_elmir_final=markers_cluster_seurat(elmir_seurat_ciara,final_cluster_version_sub,names(elmir_seurat_ciara$RNA_snn_res.0.01),5)

markers_first_elmir_1_final=markers_first_elmir_final[[1]]
markers_first_elmir_3_final=markers_first_elmir_final[[3]]
```

## Figure 2d

```{r }
geni_pgc=c("NANOS3","NANOG","DPPA5")
positive_cells=find_positive_cells(norm_elmir_ciara_5_30,threshold=0,geni_pgc)
```


### GiniClust2 old approach
```{r }


setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
load("experiment_name_FinalClustering_elmir.RData")
```

```{r}

cordinate_umap=umap_elmir[,2:3]

general_cluster_version=as.vector(umap_elmir$cluster_id)

```





```{r }


ciara_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
original_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
result_method=rep(0,length(levels(factor(finalCluster))))

original_score[colnames(norm_elmir_ciara_5_30)%in%positive_cells]=1
ciara_score[final_cluster=="PGC"]=1

for (i in 1:length(levels(factor(finalCluster)))){
  
  method_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
  method_score[finalCluster==levels(factor(finalCluster))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))


mcc(original_score, ciara_score)
```







### Giniclust3 from python script giniclust3 

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
final_gini=read.table("all_gini.txt")
final_gini=final_gini$V1

```

```{r }
geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_ciara_5_30,threshold=0,geni_marker)
final_gini=as.character(final_gini)

ciara_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
original_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
result_method=rep(0,length(levels(factor(final_gini))))

original_score[colnames(norm_elmir_ciara_5_30)%in%positive_cells]=1
ciara_score[final_cluster=="PGC"]=1

for (i in 1:length(levels(factor(final_gini)))){
  
  method_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
  method_score[final_gini==levels(factor(final_gini))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))



mcc(original_score, ciara_score)
```

### CellSIUS

### run on server hpc-build.scidom.de at path /home/ies/gabriele.lubatti/entropy_mixing/cellsius/ane
### Rscript Cellsius_elmir_new.R 

```{r}


CELLSIUS_elmir=result


setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
vedo=load("CELLSIUS_elmir_new.Rda")
general_cluster_version=meta_info$cluster_id
cluster_id=general_cluster_version
names(cluster_id)=colnames(raw_counts_human_data)
Final_Clusters = CellSIUS_final_cluster_assignment(CellSIUS.out=CELLSIUS_elmir, group_id=cluster_id, min_n_genes = 3)
 

```


```{r }

Final_Clusters=as.vector(Final_Clusters)

ciara_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
original_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
result_method=rep(0,length(levels(factor(Final_Clusters))))

original_score[colnames(norm_elmir_ciara_5_30)%in%positive_cells]=1
ciara_score[final_cluster=="PGC"]=1

for (i in 1:length(levels(factor(Final_Clusters)))){
  
  method_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
  method_score[Final_Clusters==levels(factor(Final_Clusters))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))



mcc(original_score, ciara_score)
```

### FiRE

```{r }
setwd(paste0(current_wd,"/CIARA"))
source("preprocess.R")

```

```{r }
data <- t(raw_counts_human_data)
genes <- colnames(data)#It can be replaced with original gene names

data_mat <- list(mat=data, gene_symbols=genes)

preprocessedList <- ranger_preprocess(data_mat)
preprocessedData <- as.matrix(preprocessedList$preprocessedData)

model <- new(FiRE::FiRE, 100, 50, 1017881, 5489, 0)

model$fit(preprocessedData)

score <- model$score(preprocessedData)
q3 <- quantile(score, 0.75)
iqr <- IQR(score)
th <- q3 + (1.5*iqr)
th_new=q3 + (0.5*iqr)
indIqr <- which(score >= th_new)
predictions <- integer(dim(data)[1])
predictions[indIqr] <- 1 

#model$b
```



```{r }
cluster_general=meta_info$cluster_id
method_score=rep(0,length(predictions))
method_score[cluster_general=="Primitive Streak"&predictions==1]=1

original_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
original_score[colnames(norm_elmir_ciara_5_30)%in%positive_cells]=1



mcc(method_score, original_score)
```

### Race ID 3
```{r }

sc <- SCseq(raw_counts_human_data)
sc <- filterdata(sc,mintotal=2000)
fdata <- getfdata(sc)

sc <- compdist(sc,metric="pearson")

```



```{r }
pgc_cells=colnames(raw_counts_human_data)[meta_info$sub_cluster=="PGC"]
sc@cpart[names(sc@cpart)%in%pgc_cells]

sc <- clustexp(sc,cln=15,sat=FALSE)
```

```{r }
sc <- findoutliers(sc)
```

```{r }


geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_ciara_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(sc@cpart)

ciara_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
original_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
result_method=rep(0,length(levels(factor(Final_Clusters))))

original_score[colnames(norm_elmir_ciara_5_30)%in%positive_cells]=1
ciara_score[final_cluster=="PGC"]=1

for (i in 1:length(levels(factor(Final_Clusters)))){
  
  method_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
  method_score[Final_Clusters==levels(factor(Final_Clusters))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))



mcc(original_score, ciara_score)
```

### SAM
```{r}
sam_genes=read.csv("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/sam_output/sam_rank_genes_human.csv")
sam_genes=sam_genes$X0

sam_cluster=read.csv("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/sam_output/sam_clustering_human.csv")
sam_cluster=sam_cluster$louvain_clusters
```

```{r }

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_ciara_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(sam_cluster)

ciara_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
original_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
result_method=rep(0,length(levels(factor(Final_Clusters))))

original_score[colnames(norm_elmir_ciara_5_30)%in%positive_cells]=1
ciara_score[final_cluster=="PGC"]=1

for (i in 1:length(levels(factor(Final_Clusters)))){
  
  method_score=rep(0,length(colnames(norm_elmir_ciara_5_30)))
  method_score[Final_Clusters==levels(factor(Final_Clusters))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))



mcc(original_score, ciara_score)
```

```{r }


method=factor(c("CIARA","CellSIUS","RaceID","GiniClust2","GiniClust3","SAM","FiRE"),levels=c(c("CIARA","CellSIUS","RaceID","GiniClust2","GiniClust3","SAM","FiRE")))
df=data.frame(c(1,0.17,0.53,0.11,0.44,0.30,-0.002221461),method)
colnames(df)=c("MCC","Method")


ggplot(data=df, aes(x=Method, y=MCC)) +
  geom_bar(stat="identity", width=0.5)+ylim(-0.01,1)+ggtitle("MCC score")+ggplot2::theme(text = ggplot2::element_text(size = 18), 
            axis.text.x = ggplot2::element_text(angle = 45, vjust = 1, 
                hjust = 1), axis.title.x = ggplot2::element_blank())

```

## Figure 2d

### singleCellHaystack



```{r}
elmir_seurat_5=cluster_analysis_integrate_rare(raw_counts_human_data,"Elmir_data",0.1,5,30)
norm_elmir_5_30=as.matrix(GetAssayData(elmir_seurat_5, slot = "data",assay="RNA"))
norm_elmir=norm_elmir_5_30

```


```{r}

set.seed(123)
dat.pca=as.data.frame(Embeddings(elmir_seurat_5, reduction = "pca"))
median.per.gene <- apply(norm_elmir_5_30,1,median) # get the median read count per gene
dat.detection <- norm_elmir_5_30 > median.per.gene
res.pc30 <- haystack(x = dat.pca, detection = dat.detection , method = "highD")
show_result_haystack(res.haystack = res.pc30, n = 5)
top_values=row.names(res.pc30$results)[order(res.pc30$results$log.p.adj,decreasing = F)]
cordinate_umap=coordinate_umap_human


```


```{r }
genes_important=Get_background(norm_elmir_ciara_5_30,6,0.5)
```


```{r}

#load("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data/final_cluster_version_sub.Rda")
test=Test_Fisher(final_cluster_version_sub,markers_first_elmir_3_final,top_values[1:1000],genes_important)

```

```{r}
test[[2]][test[[1]]<0.05&test[[2]]>2]
```

```{r}
marker_pgc=c("NANOS3","NANOG","SOX17","DPPA5")

match(marker_pgc,top_values)


grep("NANOS3",top_values)
which(top_values=="NANOG")
grep("SOX17",top_values)
which(top_values=="DPPA5")

```




### Triku
```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
triku_gene_name=read.table("triku_gene_names.txt")
triku_gene_name=triku_gene_name$V1
triku_gene_all=read.table("triku_gene.txt")
triku_distance=triku_gene_all$V3
triku_gene=triku_gene_all$V5

names(triku_distance)=triku_gene_name


final_sort_triku=names(triku_distance)[order(triku_distance,decreasing = T)]


```

```{r}


test=Test_Fisher(final_cluster_version_sub,markers_first_elmir_3_final,final_sort_triku[1:1000],genes_important)


```

```{r}
test[[2]][test[[1]]<0.05&test[[2]]>2]
```

```{r}
grep("NANOS3",final_sort_triku)
which(final_sort_triku=="NANOG")
grep("SOX17",final_sort_triku)
which(final_sort_triku=="DPPA5")

which(final_sort_triku=="FETUB")

```

### SAM (new approach)
```{r}
sam_genes=read.csv("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/sam_output/sam_rank_genes_human.csv")
sam_genes=sam_genes$X0
```

```{r}
test=Test_Fisher(final_cluster_version_sub,markers_first_elmir_3_final,sam_genes[1:1000],genes_important)
```

```{r}
test[[2]][test[[1]]<0.05&test[[2]]>2]
```


```{r}

marker_pgc=c("NANOS3","NANOG","SOX17","DPPA5")

index_sc=match(marker_pgc,top_values)
index_ciara=match(marker_pgc,ciara_genes_top)
index_triku=match(marker_pgc,final_sort_triku)
index_sam=match(marker_pgc,sam_genes)


index_dist=data.frame(index_ciara,index_sc,index_triku,index_sam)
index_dist=index_dist[order(index_ciara),]
index_dist_log=log(index_dist)
row.names(index_dist)=marker_pgc[order(index_ciara)]
colnames(index_dist)=c("CIARA","sCH","Triku","SAM")
index_dist=as.matrix(index_dist)
my_palette <- colorRampPalette(c("lightblue1", "black"))(n = 1000)
#my_palette <- colorRampPalette(c("", "#3182bd"))(n = 1000)

#heatmap.2(log(index_dist), scale = "none",col = bluered(100), 
          #trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1)

heatmap.2(log(index_dist), scale = "none",col = my_palette, 
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1)


```

## Figure 3b


```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/CIARA_archive/CIARA_old/inst/extdata")
load("raw_counts_ane_24_update.Rda")
mayra_seurat_24=cluster_analysis_integrate_rare(raw_counts_ane_24_update,"Mayra_data_24",0.1,5,30)
```

```{r }

frac_mito=apply(raw_counts_ane_24_update,2,function(x){
  return(sum(x[grep("mt-",row.names(raw_counts_ane_24_update))])/sum(x))
  
  
  
})


frac_ribo=apply(raw_counts_ane_24_update,2,function(x){
  frac_ribo_s=x[grep("Rps",row.names(raw_counts_ane_24_update))]
  frac_ribo_l=x[grep("Rpl",row.names(raw_counts_ane_24_update))]
  frac_ribo_all=c(frac_ribo_s,frac_ribo_l)
  return(sum(frac_ribo_all)/sum(x))



})
```


```{r }
mayra_seurat_24_update=Cluster_analysis_integrate_rare_update(raw_counts_ane_24_update,"Mayra_data_24",0.1,5,30)
norm_counts_ane_24_update=as.matrix(GetAssayData(mayra_seurat_24_update, slot = "data",assay="RNA"))
knn_matrix_ane_24_update=as.matrix(mayra_seurat_24_update@graphs$RNA_nn)
cordinate_umap_24_update=as.data.frame(Embeddings(mayra_seurat_24_update, reduction = "umap")[, 1:2])
```

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
load("ane_24.Rda")
```


```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
```

```{r }
background=row.names(result)
```


