---
title: "Comparison_Teichman"
author: "Gabriele Lubatti"
date: "3/31/2021"
output: html_document
---
```{r }
gc()
rm(list=ls())
library(ggplot2)
library(ComplexHeatmap)
library(circlize)
library(Seurat)
library(DescTools)
library(rlist)
library(devtools)
library(clustree)
library(Biobase)
library(CellSIUS)
library('FiRE')
library(RaceID)
library(singleCellHaystack)
library(mcclust)
```

```{r }
Function_fisher=function(a,b,c){
matrice=matrix(c(sum(c[c%in%a]%in%c[c%in%b]),sum(c[c%in%a]%in%c[!c%in%b]),sum(c[!c%in%a]%in%c[c%in%b]),sum(c[!c%in%a]%in%c[!c%in%b])),nrow=2,ncol=2,byrow = T)
#Fisher test
fisher.test(matrice)
}
```

```{r }
Test_Fisher_fire=function(entropy_cluster,method_cluster){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
for (i in 1:length(level)){
  set_2=names(entropy_cluster)[entropy_cluster==level[i]]
set_all=colnames(raw_elmir_5_30)
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}
```



```{r}
white_black_marker=function(cluster_race_entropy,single_cluster,norm_race,marker_list,soglia=1){
  
  white_black_7=apply(norm_race[marker_list[names(marker_list)==single_cluster],],1,function(x){
  mean_one=median(x[cluster_race_entropy==single_cluster])
  mean_different=rep(0,length(levels(factor(cluster_race_entropy[cluster_race_entropy!=single_cluster]))))
  for ( i in 1:length(levels(factor(cluster_race_entropy[cluster_race_entropy!=single_cluster])))){
  mean_different[i]=median(x[cluster_race_entropy==levels(factor(cluster_race_entropy[cluster_race_entropy!=single_cluster]))[i]])}
  
  if (mean_one>soglia&sum(mean_different)==0){
    return(TRUE)
  }
  else{return(FALSE)}
})
  return(white_black_7)
}
```
```{r }
find_jacardi=function(cluster_new,cluster_old,norm_matrix,single_new,single_old){
unione=union(colnames(norm_matrix)[cluster_new==single_new],colnames(norm_matrix)[cluster_old==single_old])
intersezione=intersect(colnames(norm_matrix)[cluster_new==single_new],colnames(norm_matrix)[cluster_old==single_old])

jacardi=length(intersezione)/length(unione)
print(jacardi)
return(jacardi)
}
```

```{r}

barplot_cell_cycle=function(cell_cycle,cluster,title,fraction=TRUE){
dfForPlot <- data.frame(Phases =cell_cycle
                                ,clu =cluster)

if(fraction==TRUE){
pnm <-ggplot(dfForPlot, aes(y=cell_cycle,x=cluster))+geom_bar( aes(fill = cell_cycle,y = (..count..)/sum(..count..)),position="fill")+ ggtitle(title)+ylab("Fraction of cells")+xlab("Cluster")+labs(fill="Elmir annotation")+theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1,size=6)) 
pnm}

if(fraction!=TRUE){
  pnm <-ggplot(dfForPlot, aes(y=cell_cycle,x=cluster))+geom_bar( aes(fill = cell_cycle,y = (..count..),position="fill"))+ ggtitle(title)+ylab("Number of cells")+xlab("Cluster")+labs(fill="Elmir annotation")+theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1,size=6)) 
pnm


}
return(list(pnm))}
```

```{r }
#install_github("ScialdoneLab/EntropyMixingR",auth_token="8f6bf418b6ea0274f5f832b3a96de9b63be0997a",ref="master")


```

```{r }
library(CIARA)
```

```{r }
#load(system.file("extdata", "raw_elmir_5_30.Rda", package ="CIARA"))
#raw_counts=raw_elmir_5_30

setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/CIARA_archive/CIARA_old/inst/extdata")
load("raw_elmir_5_30.Rda")
raw_counts=raw_elmir_5_30
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/CIARA_archive/CIARA_old/inst/extdata")
load("elmir_december_2021.Rda")

umap_elmir <- readRDS(system.file("extdata", "annot_umap.rds", package = "CIARA"))

coordinate_umap_human <- umap_elmir[, 2:3]


#setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/CIARA_archive/CIARA_old/inst/extdata")
#save(hvg_human_gastrula,file="hvg_human_gastrula.Rda")

```
## New GiniClust2 approach
```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/GiniClust2-master/risultato_elmir_new/results")
vedo=load("experiment_name_FinalClustering.RData")
vedo=load("experiment_name_StatisticsTable_afterLOESS.RData")

ExprM.Stat2["DPPA5",8]
ExprM.Stat2["NANOS3",8]

ExprM.Stat2["PPM1N",8]

grep("DPPA5",Genelist.top_pvalue)
grep("NANOS3",Genelist.top_pvalue)

length(Genelist.top_pvalue)

```
```{r }
plot_umap(coordinate_umap_human,finalCluster)
```

```{r }
table(final_cluster_version_sub,finalCluster)
```



## Stop new GiniClust2 approach


```{r }
#load(system.file("extdata", "raw_elmir_5_30.Rda", package ="IDENTOM"))
#load(system.file("extdata", "CELLSIUS_elmir.Rda", package ="EntropyMixingR"))
#CELLSIUS_elmir=result

setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
vedo=load("experiment_name_StatisticsTable_afterLOESS_elmir.RData")
load("experiment_name_FinalClustering_elmir.RData")
vedo=load("CELLSIUS_elmir.Rda")
CELLSIUS_elmir=result

#vedo=load(system.file("extdata", "experiment_name_StatisticsTable_afterLOESS_elmir.RData", package ="EntropyMixingR"))



#vedo=load(system.file("extdata", "experiment_name_FinalClustering_elmir.RData", package ="EntropyMixingR"))



setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load(file="final_cluster_version_sub.Rda")

#vedo=load(system.file("extdata", "elmir_entropy_5_30.Rda", package ="EntropyMixingR"))

```

```{r}

cordinate_umap=umap_elmir[,2:3]

general_cluster_version=as.vector(umap_elmir$cluster_id)

```



## Giniclust2 
```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/GiniClust2-master/risultato/results")
final_geni=load("experiment_name_GeneList_final.RData")
#GeneList.final

```


```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load("norm_elmir_5_30.Rda")
```

```{r }


plot_gene(norm_elmir_5_30,cordinate_umap,"NANOS3","NANOS3")
plot_gene(norm_elmir_5_30,cordinate_umap,"DPPA5","DPPA5")
plot_gene(norm_elmir_5_30,cordinate_umap,"NANOG","NANOG")

```

```{r }
find_positive_cells=function(norm_elmir_5_30,geni_marker,threshold){

logic_cell=apply(norm_elmir_5_30[geni_marker,],2,function(x){
  
  if (sum(x>threshold)==length(x))
  {return(TRUE)}
  else{return(FALSE)}
})
positive_cells=colnames(norm_elmir_5_30)[logic_cell]
return(positive_cells)
}



```

```{r }
find_jacardi_new=function(cluster_new,norm_matrix,single_new,cells_positive){
unione=union(colnames(norm_matrix)[cluster_new==single_new],cells_positive)
intersezione=intersect(colnames(norm_matrix)[cluster_new==single_new],cells_positive)

jacardi=length(intersezione)/length(unione)
print(jacardi)
return(jacardi)
}
```

```{r }
find_top_marker=function(marker_elmir_all,norm_elmir_5_30,name_cluster,fraction){
geni_7=marker_elmir_all[names(marker_elmir_all)==name_cluster]
logic_7=apply(norm_elmir_5_30[geni_7,final_cluster_version_sub==name_cluster],1,function(x){
  if (length(x[x>1])>=(length(x)*fraction)){
    return(TRUE)
  }
  else{return(FALSE)}
})


geni_7_top=geni_7[logic_7]
names(geni_7_top)=rep(name_cluster,length(geni_7_top))

return(geni_7_top)
}
```


##For PGC definition
```{r }
geni_pgc=c("NANOS3","NANOG","DPPA5")
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_pgc)
```

```{r }
for (i in 1:length(names(table(as.character(finalCluster))))){

bo=find_jacardi_new(as.character(finalCluster),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}

```


```{r }
library("mltools")
#mcc()
#Matthews correlation coefficient 
#methods for quantifying agreement between binary classification (from GiniClust2 paper) (values from -1 to +1)
#preds <- c(1,1,1,0,1,1,0,0)
#actuals <- c(1,1,1,1,0,0,0,0)

ciara_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score=rep(0,length(colnames(norm_elmir_5_30)))
result_method=rep(0,length(levels(factor(finalCluster))))

original_score[colnames(norm_elmir_5_30)%in%positive_cells]=1
ciara_score[final_cluster_version_sub=="PGC"]=1

for (i in 1:length(levels(factor(finalCluster)))){
  
  method_score=rep(0,length(colnames(norm_elmir_5_30)))
  method_score[finalCluster==levels(factor(finalCluster))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))

#with FiRE

mcc(original_score, ciara_score)
```



```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load(file="markers_first_elmir_final.Rda")
marker_elmir_all=markers_first_elmir_final[[3]]


load("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data/final_cluster_version_sub.Rda")
```



## Yes first approach


## Top ExE meso
```{r}



top_endo=white_black_markers(final_cluster_version_sub,"ExE Mesoderm_1",norm_elmir_5_30,marker_elmir_all,0)
top_endo=names(top_endo)[top_endo]


mean_top_endo=apply(norm_elmir_5_30[top_endo,final_cluster_version_sub=="ExE Mesoderm_1"],1,mean)
mean_top_endo=sort(mean_top_endo,decreasing = T)

top_endo=names(mean_top_endo)[1:4]
names(top_endo)=rep("ExE Mesoderm_1",length(top_endo))

plot_balloon_marker(norm_elmir_5_30,final_cluster_version_sub,top_endo,length(top_endo),max_size=5,text_size=10)

geni_marker=top_endo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

for (i in 1:length(names(table(as.character(finalCluster))))){

bo=find_jacardi_new(as.character(finalCluster),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


```

## Top endo
```{r}



top_endo=white_black_markers(final_cluster_version_sub,"Endoderm_2",norm_elmir_5_30,marker_elmir_all,1)
top_endo=names(top_endo)[top_endo]


mean_top_endo=apply(norm_elmir_5_30[top_endo,final_cluster_version_sub=="Endoderm_2"],1,mean)
mean_top_endo=sort(mean_top_endo,decreasing = T)

top_endo=names(mean_top_endo)[1:4]
names(top_endo)=rep("Endoderm_2",length(top_endo))

plot_balloon_marker(norm_elmir_5_30,final_cluster_version_sub,top_endo,length(top_endo),max_size=5,text_size=10)

geni_marker=top_endo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

for (i in 1:length(names(table(as.character(finalCluster))))){

bo=find_jacardi_new(as.character(finalCluster),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


```

## Top hemo
```{r}



top_hemo=white_black_markers(final_cluster_version_sub,"Hemogenic Endothelial Progenitors_4",norm_elmir_5_30,marker_elmir_all,1)
top_hemo=names(top_hemo)[top_hemo]


mean_top_hemo=apply(norm_elmir_5_30[top_hemo,final_cluster_version_sub=="Hemogenic Endothelial Progenitors_4"],1,mean)
mean_top_hemo=sort(mean_top_hemo,decreasing = T)

top_hemo=names(mean_top_hemo)[1:4]
names(top_hemo)=rep("Hemogenic Endothelial Progenitors_4",length(top_hemo))

plot_balloon_marker(norm_elmir_5_30,final_cluster_version_sub,top_hemo,length(top_hemo),max_size=5,text_size=4)

geni_marker=top_hemo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

for (i in 1:length(names(table(as.character(finalCluster))))){

bo=find_jacardi_new(as.character(finalCluster),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


```


## GiniClust2


```{r }
plot_umap(cordinate_umap,as.character(finalCluster))
```


## Start cluster and baloon plot analysis 
```{r}
DefaultAssay(elmir_seurat_5) <- "RNA"
markers_first_elmir=markers_cluster_seurat(elmir_seurat_5,finalCluster,names(elmir_seurat_5$RNA_snn_res.0.1),5)
```



```{r}
marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]

```

```{r }
norm_counts_small = apply(norm_elmir_5_30, 
        1, function(x) {
            y = x/sum(x)
            return(y)
        })
norm_counts_small=t(norm_counts_small)


plot_balloon_marker_norm(norm_counts_small,finalCluster,marker_all_day_24_first,5,max_size=5,text_size=10)

plot_balloon_marker(norm_elmir_5_30,finalCluster,marker_all_day_24_first,5,max_size=3,text_size=8)

#plot_balloon_marker_norm(norm_counts_small[,grep(paste(toMatch,collapse="|"),original_all)],original_sub[grep(paste(to#Match,collapse="|"),original_all)],markers_first_elmir_3_final,5,max_size=5,text_size=10)
```

```{r}
table(final_cluster_version_sub,finalCluster)
```

```{r }



for (i in levels(factor(finalCluster))){
jacardi=find_jacardi(final_cluster_version_sub,finalCluster,raw_elmir_5_30,"Hemogenic Endothelial Progenitors_4",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(finalCluster))){
jacardi=find_jacardi(final_cluster_version_sub,finalCluster,raw_elmir_5_30,"Endoderm_2",i)
  print(paste0(i,"-",jacardi))
}


for (i in levels(factor(finalCluster))){
jacardi=find_jacardi(final_cluster_version_sub,finalCluster,raw_elmir_5_30,"ExE Mesoderm_1",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(finalCluster))){
jacardi=find_jacardi(final_cluster_version_sub,finalCluster,raw_elmir_5_30,"PGC",i)
  print(paste0(i,"-",jacardi))
}

```





## Comparison with higi gini index

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
vedo=load("elmir.Rda")
```


```{r }
#setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
#vedo=load("elmir_hyper_old.Rda")

```

```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
background=row.names(result)
```








```{r }
library(UpSetR)
listInput <- list(entropy_genes=ciara_genes,gini_genes=GeneList.final)

upset(fromList(listInput), order.by = "freq")

listInput <- list(entropy_genes=ciara_genes[1:100],gini_genes=GeneList.final)

upset(fromList(listInput), order.by = "freq")


```

```{r }
Function_fisher=function(a,b,c){
matrice=matrix(c(sum(c[c%in%a]%in%c[c%in%b]),sum(c[c%in%a]%in%c[!c%in%b]),sum(c[!c%in%a]%in%c[c%in%b]),sum(c[!c%in%a]%in%c[!c%in%b])),nrow=2,ncol=2,byrow = T)
#Fisher test
fisher.test(matrice)
}
```

```{r}
Test_Fisher=function(entropy_cluster,markers_cluster,marker_top){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
set_1=marker_top
for (i in 1:length(level)){
  set_2=markers_cluster[names(markers_cluster)==level[i]]
set_all=markers_cluster
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}

```




```{r }
Function_fisher(ciara_genes,GeneList.final,union(row.names(ExprM.Stat2),background))

#"NANOS3"
#"NANOG"
#"SOX17"
#"DPPA5"

```


## Comparison for PGC: gini index vs entropy of mixing

```{r}
#vedo=load(system.file("extdata", "experiment_name_StatisticsTable_afterLOESS_elmir.RData", package ="EntropyMixingR"))
#"ExprM.Stat2"   

#setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
#vedo=load("elmir_hyper_old.Rda")


ciara_genes=row.names(result)[result[,2]<1]

max_gini=ExprM.Stat2$log2.Maxs
gini_value=ExprM.Stat2$Gini
#max_gini=gini_index$log2..Max.Expression.Level..


label_all=c(rep("No Gini gene",length(max_gini)))
#label_all[ExprM.Stat2$Gini.pvalue<0.0001]="Gini gene"
label_all[row.names(ExprM.Stat2)%in%Genelist.top_pvalue]="Gini gene"

mtcars=data.frame(label_all,gini_value,max_gini)
ggplot(mtcars, aes(x=max_gini, y=gini_value, color=label_all)) +
  geom_point()+xlab("log2 (Max Expression Level)")+ylab("Gini")+labs(color="Label")



label_all=c(rep("No CIARA gene",length(max_gini)))
label_all[row.names(ExprM.Stat2)%in%ciara_genes]="CIARA gene"

mtcars=data.frame(label_all,gini_value,max_gini)
row.names(mtcars)=row.names(ExprM.Stat2)
mtcars=mtcars[c(row.names(ExprM.Stat2)[!row.names(ExprM.Stat2)%in%ciara_genes],row.names(ExprM.Stat2)[row.names(ExprM.Stat2)%in%ciara_genes]),]
ggplot(mtcars, aes(x=max_gini, y=gini_value, color=label_all)) +
  geom_point()+xlab("log2 (Max Expression Level)")+ylab("Gini")+labs(color="Label")


```

## End GiniClust2 

## GiniClust3 new version

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
final_gini=read.table("all_gini_new.txt")
final_gini=final_gini$V1
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
only_gini=read.table("only_gini_new.txt")
only_gini=only_gini$V1
plot_umap(cordinate_umap,final_gini)
plot_umap(cordinate_umap,only_gini)


setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
gini3_genes=read.table("gini3_genes_new.txt")
gini3_genes_names=read.table("gini3_genes_name_new.txt")
row.names(gini3_genes)=gini3_genes_names$V1
gini3_geni=row.names(gini3_genes)[gini3_genes$V2=="True"]

#which(gini3_geni%in%geni_pgc)

plot_gene(norm_elmir_5_30,cordinate_umap,"NUDT11","NUDT11")
```

## analysis to see if Giniclust3 produces overfitting


```{r}
library(Biobase)
#elmir_seurat_5=cluster_analysis_integrate_rare(raw_elmir_5_30,"Elmir_data",0.1,5,30)
DefaultAssay(elmir_seurat_5) <- "RNA"
markers_first_gini3=markers_cluster_seurat(elmir_seurat_5,final_gini,names(elmir_seurat_5$RNA_snn_res.0.1),30)


```
```{r}
markers_first_elmir=markers_first_gini3

marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]



```
```{r}


white_black_11=white_black_markers(final_gini,0,norm_elmir_5_30,marker_all_day_24_first,0)
sum(white_black_11)

white_black_11=white_black_markers(final_gini,1,norm_elmir_5_30,marker_all_day_24_first,0)
sum(white_black_11)

white_black_11=white_black_markers(final_gini,2,norm_elmir_5_30,marker_all_day_24_first,0)
sum(white_black_11)

white_black_11=white_black_markers(final_gini,3,norm_elmir_5_30,marker_all_day_24_first,0)
sum(white_black_11)

white_black_11=white_black_markers(final_gini,4,norm_elmir_5_30,marker_all_day_24_first,0)
sum(white_black_11)

white_black_11=white_black_markers(final_gini,5,norm_elmir_5_30,marker_all_day_24_first,0)
sum(white_black_11)








```

```{r }
bo=CIARA::cluster_analysis_integrate_rare(raw_elmir_5_30,"bo",0.1,5,30,gini3_geni)
```
```{r }
find_resolution(bo,seq(0.1,1,0.1))
bo=FindClusters(bo,resolution = 0.4)
```


```{r }
library("mltools")
#mcc()
#Matthews correlation coefficient 
#methods for quantifying agreement between binary classification (from GiniClust2 paper) (values from -1 to +1)
#preds <- c(1,1,1,0,1,1,0,0)
#actuals <- c(1,1,1,1,0,0,0,0)

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
final_gini=as.character(final_gini)

ciara_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score=rep(0,length(colnames(norm_elmir_5_30)))
result_method=rep(0,length(levels(factor(final_gini))))

original_score[colnames(norm_elmir_5_30)%in%positive_cells]=1
ciara_score[final_cluster_version_sub=="PGC"]=1

for (i in 1:length(levels(factor(final_gini)))){
  
  method_score=rep(0,length(colnames(norm_elmir_5_30)))
  method_score[final_gini==levels(factor(final_gini))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))



mcc(original_score, ciara_score)
```

## Giniclust3 from python script giniclust3 

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
final_gini=read.table("all_gini.txt")
final_gini=final_gini$V1
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
only_gini=read.table("only_gini.txt")
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
gini3_genes=read.table("gini3_genes.txt")
gini3_genes_names=read.table("gini3_genes_name.txt")
row.names(gini3_genes)=gini3_genes_names$V1
gini3_geni=row.names(gini3_genes)[gini3_genes$V2=="True"]

#which(geni_pgc%in%gini3_geni)

only_gini=only_gini$V1
Plot_umap(cordinate_umap,final_gini)
Plot_umap(cordinate_umap,only_gini)
```


## Start cluster and baloon plot analysis 
```{r}
DefaultAssay(elmir_seurat_5) <- "RNA"
markers_first_elmir=markers_cluster_seurat(elmir_seurat_5,final_gini,names(elmir_seurat_5$RNA_snn_res.0.1),5)
```



```{r}
marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]

```

```{r }
norm_counts_small = apply(norm_elmir_5_30, 
        1, function(x) {
            y = x/sum(x)
            return(y)
        })
norm_counts_small=t(norm_counts_small)


plot_balloon_marker_norm(norm_counts_small,final_gini,marker_all_day_24_first,5,max_size=5,text_size=10)

plot_balloon_marker(norm_elmir_5_30,final_gini,marker_all_day_24_first,3,max_size=3,text_size=6)

#plot_balloon_marker_norm(norm_counts_small[,grep(paste(toMatch,collapse="|"),original_all)],original_sub[grep(paste(to#Match,collapse="|"),original_all)],markers_first_elmir_3_final,5,max_size=5,text_size=10)
```






## New approach with positive cells
```{r }




geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

final_gini=as.character(final_gini)

for (i in levels(factor(final_gini))){
print(i)
bo=find_jacardi_new((final_gini),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


geni_marker=top_endo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

final_gini=as.character(final_gini)

for (i in levels(factor(final_gini))){
print(i)
bo=find_jacardi_new((final_gini),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}

geni_marker=top_hemo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

for (i in levels(factor(final_gini))){
print(i)
bo=find_jacardi_new((final_gini),norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}
```

##MCC approach

```{r }
library("mltools")
#mcc()
#Matthews correlation coefficient 
#methods for quantifying agreement between binary classification (from GiniClust2 paper) (values from -1 to +1)
#preds <- c(1,1,1,0,1,1,0,0)
#actuals <- c(1,1,1,1,0,0,0,0)

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
final_gini=as.character(final_gini)

ciara_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score=rep(0,length(colnames(norm_elmir_5_30)))
result_method=rep(0,length(levels(factor(final_gini))))

original_score[colnames(norm_elmir_5_30)%in%positive_cells]=1
ciara_score[final_cluster_version_sub=="PGC"]=1

for (i in 1:length(levels(factor(final_gini)))){
  
  method_score=rep(0,length(colnames(norm_elmir_5_30)))
  method_score[final_gini==levels(factor(final_gini))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))

#with FiRE

mcc(original_score, ciara_score)
```


## Old approach with intersection between cluster

```{r }
for (i in levels(factor(final_gini))){
jacardi=find_jacardi(final_cluster_version_sub,final_gini,raw_elmir_5_30,"Endoderm_2",i)
  print(paste0(i,"-",jacardi))
}


for (i in levels(factor(final_gini))){
jacardi=find_jacardi(final_cluster_version_sub,final_gini,raw_elmir_5_30,"Hemogenic Endothelial Progenitors_4",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(final_gini))){
jacardi=find_jacardi(final_cluster_version_sub,final_gini,raw_elmir_5_30,"PGC",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(final_gini))){
jacardi=find_jacardi(final_cluster_version_sub,final_gini,raw_elmir_5_30,"ExE Mesoderm_1",i)
  print(paste0(i,"-",jacardi))
}



```


## Comparison with Triku
```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
triku_gene_name=read.table("triku_gene_names.txt")
triku_gene_name=triku_gene_name$V1
triku_gene_all=read.table("triku_gene.txt")
triku_distance=triku_gene_all$V3
triku_gene=triku_gene_all$V5

#triku_gene_name=triku_gene_name[triku_gene=="True"]

names(triku_distance)=triku_gene_name

load("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data/final_cluster_version_sub.Rda")

final_sort_triku=names(triku_distance)[order(triku_distance,decreasing = T)]


```

```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
vedo=load("elmir.Rda")
ciara_genes=row.names(result)[result[,1]<1]
#geni_top_top_old=row.names(result)[order(as.numeric(result[,1]))]

final_sort_triku=final_sort_triku[final_sort_triku%in%geni_top_top]

```





```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load(file="markers_first_elmir_final.Rda")
marker_elmir_all=markers_first_elmir_final[[3]]
```

```{r }
genes_important=Get_background(norm_elmir,6,0.5)
```
```{r}
Test_Fisher=function(entropy_cluster,markers_cluster,marker_top,background){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
set_1=marker_top
for (i in 1:length(level)){
  set_2=markers_cluster[names(markers_cluster)==level[i]]
set_all=background
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}
```

```{r}


test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,final_sort_triku[1:1000],genes_important)

test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,geni_top_top[1:1000],genes_important)

```

```{r}
test[[2]][test[[1]]<0.01&test[[2]]>2]
```

```{r}
grep("NANOS3",triku_gene_name)
which(triku_gene_name=="NANOG")
grep("SOX17",triku_gene_name)
which(triku_gene_name=="DPPA5")



grep("NANOS3",final_sort_triku)
which(final_sort_triku=="NANOG")
grep("SOX17",final_sort_triku)
which(final_sort_triku=="DPPA5")

which(final_sort_triku=="FETUB")

```

```{r}
library(CIARA)
load(system.file("extdata", "norm_human_data_ciara.Rda", package = "CIARA"))
umap_elmir <- readRDS(system.file("extdata", "annot_umap.rds", package = "CIARA"))

coordinate_umap_human <- umap_elmir[, 2:3]

setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load("norm_elmir_5_30.Rda")

p <- list()
for(i in final_sort_triku[1:10]) {
  q <- plot_gene(norm_elmir_5_30, coordinate_umap_human, i, i)
  p <- list(p, q)
}
p


load(system.file("extdata", "result.Rda", package = "CIARA"))

ciara_genes_top <- row.names(result)[order(as.numeric(result[, 1]))]
ciara_genes <- row.names(result)[result[, 1]<1]


p <- list()
for(i in ciara_genes_top[1:2]) {
  q <- plot_gene(norm_elmir_5_30, coordinate_umap_human, i, i)
  p <- list(p, q)
}
p

which(final_sort_triku %in% ciara_genes_top[1:2])

length(intersect(final_sort_triku[1:2000],ciara_genes))

```

```{r}

setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/CIARA_archive/CIARA_old/inst/extdata")
vedo=load("raw_elmir_5_30.Rda")
human_data_triku <- cluster_analysis_integrate_rare(raw_elmir_5_30, "Human_data", 0.1, 5, 30, feature_genes = final_sort_triku[1:1000])

plot_umap(coordinate_umap_human, human_data_triku$RNA_snn_res.0.1)


find_resolution(human_data_triku, seq(0.01,0.5,0.1))


```



## Comparison with CellSIUS

## run on server hpc-build.scidom.de at path /home/ies/gabriele.lubatti/entropy_mixing/cellsius/ane
## Rscript Cellsius_elmir_new.R 

```{r}
library(CellSIUS)

CELLSIUS_elmir=result

#Below the changed version of cellsius for detecting PGC (in this way we don't detect any more sub endo 2 and hemo_4)
 setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
 vedo=load("CELLSIUS_elmir_new.Rda")
 general_cluster_version=umap_elmir$cluster_id
 cluster_id=general_cluster_version
names(cluster_id)=colnames(raw_elmir_5_30)
 Final_Clusters = CellSIUS_final_cluster_assignment(CellSIUS.out=CELLSIUS_elmir, group_id=cluster_id, min_n_genes = 3)
 #Standard version with standard parameters (we don't detect PGC)
 #Final_Clusters = CellSIUS_final_cluster_assignment(CellSIUS.out=CellSIUS_elmir, group_id=cluster_id, min_n_genes = 3)

```

```{r }
plot_umap(cordinate_umap,Final_Clusters)
plot_umap(cordinate_umap,Final_Clusters_new)
plot_umap(cordinate_umap,cluster_id)
```
## Start cluster and baloon plot analysis 
```{r}
DefaultAssay(elmir_seurat_5) <- "RNA"

excluded=names(table(Final_Clusters)[table(Final_Clusters)<3])
index_select=!(Final_Clusters%in%excluded)

#levels(Final_Clusters)=seq(1,length(unique(Final_Clusters)))
Final_Clusters_new=Final_Clusters
for ( i in 1:length(unique(Final_Clusters))){
  Final_Clusters_new[Final_Clusters==unique(Final_Clusters)[i]]=i
}
markers_first_elmir=markers_cluster_seurat(elmir_seurat_5[,index_select],Final_Clusters_new[index_select],names(elmir_seurat_5$RNA_snn_res.0.1)[index_select],5)
```



```{r}
marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]

```

```{r }
norm_counts_small = apply(norm_elmir_5_30, 
        1, function(x) {
            y = x/sum(x)
            return(y)
        })
norm_counts_small=t(norm_counts_small)


#plot_balloon_marker_norm(norm_counts_small,Final_Clusters,marker_all_day_24_first,5,max_size=5,text_size=10)

plot_balloon_marker(norm_elmir_5_30[,index_select],Final_Clusters_new[index_select],marker_all_day_24_first,5,max_size=2,text_size=4)


```
##End cluster and baloon
```{r }


geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(Final_Clusters)

for (i in levels(factor(Final_Clusters))){
  print(i)
bo=find_jacardi_new(Final_Clusters,norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


geni_marker=top_endo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(Final_Clusters)

for (i in levels(factor(Final_Clusters))){
  print(i)
bo=find_jacardi_new(Final_Clusters,norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


geni_marker=top_hemo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(Final_Clusters)

for (i in levels(factor(Final_Clusters))){
  print(i)
bo=find_jacardi_new(Final_Clusters,norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",i))
  }
}


```

## analysis to see if cellsius produces overfitting





```{r}
library(Biobase)
#elmir_seurat_5=cluster_analysis_integrate_rare(raw_elmir_5_30,"Elmir_data",0.1,5,30)
DefaultAssay(elmir_seurat_5) <- "RNA"
selecting_cluster=names(table(Final_Clusters))[table(Final_Clusters)>=3]
markers_first_gini3=markers_cluster_seurat(elmir_seurat_5[,Final_Clusters%in%selecting_cluster],Final_Clusters[Final_Clusters%in%selecting_cluster],names(elmir_seurat_5$RNA_snn_res.0.1)[Final_Clusters%in%selecting_cluster],30)


```

```{r}
markers_first_elmir=markers_first_gini3

marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]



```
```{r}

final_sum=rep(0,length(selecting_cluster))
for (i in 1:length(selecting_cluster)){
white_black_11=white_black_markers(Final_Clusters[Final_Clusters%in%selecting_cluster],selecting_cluster[i],norm_elmir_5_30[,Final_Clusters%in%selecting_cluster],marker_all_day_24_first,0)
print(sum(white_black_11))
final_sum[i]=sum(white_black_11)
}







```
## MCC
```{r }
library("mltools")
#mcc()
#Matthews correlation coefficient 
#methods for quantifying agreement between binary classification (from GiniClust2 paper) (values from -1 to +1)
#preds <- c(1,1,1,0,1,1,0,0)
#actuals <- c(1,1,1,1,0,0,0,0)

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(Final_Clusters)

ciara_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score=rep(0,length(colnames(norm_elmir_5_30)))
result_method=rep(0,length(levels(factor(Final_Clusters))))

original_score[colnames(norm_elmir_5_30)%in%positive_cells]=1
ciara_score[final_cluster_version_sub=="PGC"]=1

for (i in 1:length(levels(factor(Final_Clusters)))){
  
  method_score=rep(0,length(colnames(norm_elmir_5_30)))
  method_score[Final_Clusters==levels(factor(Final_Clusters))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))

#with FiRE

mcc(original_score, ciara_score)
```

```{r }
table(final_cluster_version_sub,Final_Clusters)
```



```{r }
table(final_cluster_version_sub,Final_Clusters)
```

```{r }

for (i in levels(factor(Final_Clusters))){
jacardi=find_jacardi(final_cluster_version_sub,Final_Clusters,raw_elmir_5_30,"Hemogenic Endothelial Progenitors_4",i)
  print(paste0(i,"-",jacardi))
}








for (i in levels(factor(Final_Clusters))){
jacardi=find_jacardi(final_cluster_version_sub,Final_Clusters,raw_elmir_5_30,"Endoderm_2",i)
  print(paste0(i,"-",jacardi))
}


for (i in levels(factor(Final_Clusters))){
jacardi=find_jacardi(final_cluster_version_sub,Final_Clusters,raw_elmir_5_30,"ExE Mesoderm_1",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(Final_Clusters))){
jacardi=find_jacardi(final_cluster_version_sub,Final_Clusters,raw_elmir_5_30,"PGC",i)
  print(paste0(i,"-",jacardi))
}




```




```{r }

Final_Clusters_plot=Final_Clusters
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors_1"]="Hemogenic Endothelial Progenitors_sub_1"
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors_2"]="Hemogenic Endothelial Progenitors_sub_2"
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors_3"]="Hemogenic Endothelial Progenitors_sub_3"
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors_3-Hemogenic Endothelial Progenitors_1 "]="Hemogenic Endothelial Progenitors_sub_1"
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors_4"]="Hemogenic Endothelial Progenitors_sub_4"
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors"]="Hemogenic Endothelial Progenitors_sub_0"
Final_Clusters_plot[Final_Clusters=="Hemogenic Endothelial Progenitors_3-Hemogenic Endothelial Progenitors_1"]="Ambigous"
Final_Clusters_plot[Final_Clusters=="Endoderm"]="Endoderm_sub_0"
Final_Clusters_plot[Final_Clusters=="Endoderm_1"]="Endoderm_sub_1"
Final_Clusters_plot[Final_Clusters=="ExE Mesoderm"]="ExE Mesoderm_sub_0"
Final_Clusters_plot[Final_Clusters=="ExE Mesoderm_1"]="ExE Mesoderm_sub_1"



```






```{r }
Plot_umap(cordinate_umap,Final_Clusters)
```



## FiRE
```{r }

#setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/FIRE")
#source('preprocess.R')

source(system.file("extdata", "preprocess.R", package ="EntropyMixingR"))

```

```{r }
data <- t(raw_elmir_5_30)
genes <- colnames(data)#It can be replaced with original gene names

data_mat <- list(mat=data, gene_symbols=genes)

preprocessedList <- ranger_preprocess(data_mat)
preprocessedData <- as.matrix(preprocessedList$preprocessedData)

model <- new(FiRE::FiRE, 100, 50, 1017881, 5489, 0)

model$fit(preprocessedData)

score <- model$score(preprocessedData)
q3 <- quantile(score, 0.75)
iqr <- IQR(score)
th <- q3 + (1.5*iqr)
th_new=q3 + (0.5*iqr)
indIqr <- which(score >= th_new)
predictions <- integer(dim(data)[1])
predictions[indIqr] <- 1 

#model$b
```


```{r }
cluster_plot=predictions
cluster_plot[predictions==1]="Rare cells"
cluster_plot[predictions==0]="NO Rare cells"
plot_umap(cordinate_umap,cluster_plot)
```

```{r }
table(cluster_plot)
```










```{r }
predictions <- integer(dim(data)[1])
predictions[indIqr] <- 1 
names(predictions)=colnames(raw_elmir_5_30)
set_1=names(predictions)[predictions==1]
final_cluster_version_sub_new=final_cluster_version_sub
names(final_cluster_version_sub_new)=colnames(raw_elmir_5_30)


test=Test_Fisher_fire(final_cluster_version_sub_new,predictions)
```

```{r }
test[[2]][test[[1]]<=0.05&test[[2]]>2]
```

```{r }
table(final_cluster_version_sub,predictions)
```


##New part







```{r }
#top_hemo
#top_endo
#positive_cells_pgc=find_positive_cells(norm_elmir_5_30,threshold=0,top_endo)
#positive_cells_pgc=find_positive_cells(norm_elmir_5_30,threshold=0,top_hemo)
positive_cells_pgc=find_positive_cells(norm_elmir_5_30,threshold=0,geni_pgc)
positive_cells_other=colnames(norm_elmir_5_30)[!colnames(norm_elmir_5_30)%in%positive_cells_pgc]

predictions_small_pgc=predictions[names(predictions)%in%positive_cells_pgc]
predictions_small_other=predictions[names(predictions)%in%positive_cells_other]

predictions_small_all=c(predictions_small_pgc,predictions_small_other)

cluster_pgc=rep("Positive PGC",length(positive_cells_pgc))
cluster_other=rep("OTHER",length(positive_cells_other))
cluster_all=c(cluster_pgc,cluster_other)


names(cluster_all)=c(positive_cells_pgc,positive_cells_other)


test=Test_Fisher_fire(cluster_all,predictions_small_all)
```

```{r }
test[[2]][test[[1]]<=0.05&test[[2]]>2]
```

##mcc for FiRE
```{r }
cluster_general=umap_elmir$cluster_id
method_score=rep(0,length(predictions))
method_score[cluster_general=="Primitive Streak"&predictions==1]=1

original_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score[colnames(norm_elmir_5_30)%in%positive_cells_pgc]=1



mcc(method_score, original_score)
```

## Race ID 3
```{r }

sc <- SCseq(raw_elmir_5_30)
sc <- filterdata(sc,mintotal=2000)
fdata <- getfdata(sc)

sc <- compdist(sc,metric="pearson")

#sc <- clustexp(sc,clustnr =30)
```



```{r }
pgc_cells=colnames(raw_elmir_5_30)[umap_elmir$sub_cluster=="PGC"]
sc@cpart[names(sc@cpart)%in%pgc_cells]

sc <- clustexp(sc,cln=15,sat=FALSE)
```

```{r }
sc <- findoutliers(sc)
```








```{r }
Plot_umap(cordinate_umap,sc@cpart)
```
## Start with cluster and baloon plot
```{r}
Final_Clusters=as.vector(sc@cpart)
DefaultAssay(elmir_seurat_5) <- "RNA"

excluded=names(table(Final_Clusters)[table(Final_Clusters)<3])
index_select=!(Final_Clusters%in%excluded)

#levels(Final_Clusters)=seq(1,length(unique(Final_Clusters)))

markers_first_elmir=markers_cluster_seurat(elmir_seurat_5[,index_select],Final_Clusters[index_select],names(elmir_seurat_5$RNA_snn_res.0.1)[index_select],5)
```



```{r}
marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]

```

```{r }
norm_counts_small = apply(norm_elmir_5_30, 
        1, function(x) {
            y = x/sum(x)
            return(y)
        })
norm_counts_small=t(norm_counts_small)


#plot_balloon_marker_norm(norm_counts_small,Final_Clusters,marker_all_day_24_first,5,max_size=5,text_size=10)

plot_balloon_marker(norm_elmir_5_30[,index_select],Final_Clusters[index_select],marker_all_day_24_first,2,max_size=2,text_size=6)


```


```{r }
Final_Clusters=as.vector(sc@cpart)

geni_marker=top_endo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

table(Final_Clusters[colnames(raw_elmir_5_30)%in%positive_cells])

for (i in levels(factor(Final_Clusters))){
  print(i)
bo=find_jacardi_new(Final_Clusters,norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",Final_Clusters[i]))
  }
}

geni_marker=top_hemo
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

table(Final_Clusters[colnames(raw_elmir_5_30)%in%positive_cells])

for (i in levels(factor(Final_Clusters))){
  print(i)
bo=find_jacardi_new(Final_Clusters,norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",Final_Clusters[i]))
  }
}

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)

table(Final_Clusters[colnames(raw_elmir_5_30)%in%positive_cells])

for (i in levels(factor(Final_Clusters))){
  print(i)
bo=find_jacardi_new(Final_Clusters,norm_elmir_5_30,i,positive_cells)
  if (bo>=0.50){
    print(paste0("yes we have-",Final_Clusters[i]))
  }
}
```





```{r }
table(sc@cpart)
```
```{r }
#outliers cells
out_cells=sc@out$out
length(out_cells)
table(general_cluster_version[colnames(raw_elmir_5_30)%in%out_cells])
```
```{r }
outlier_cluster=general_cluster_version
outlier_cluster[colnames(raw_elmir_5_30)%in%out_cells]="Outliers"
outlier_cluster[!colnames(raw_elmir_5_30)%in%out_cells]="NO Outliers"


Plot_umap(cordinate_umap,outlier_cluster)
```



```{r}
for (i in levels(factor(sc@cpart))){
jacardi=find_jacardi(final_cluster_version_sub,sc@cpart,raw_elmir_5_30,"Endoderm_2",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(sc@cpart))){
jacardi=find_jacardi(final_cluster_version_sub,sc@cpart,raw_elmir_5_30,"Hemogenic Endothelial Progenitors_4",i)
  print(paste0(i,"-",jacardi))
}

for (i in levels(factor(sc@cpart))){
jacardi=find_jacardi(final_cluster_version_sub,sc@cpart,raw_elmir_5_30,"ExE Mesoderm_1",i)
  print(paste0(i,"-",jacardi))
}

```

## MCC
```{r }
library("mltools")
#mcc()
#Matthews correlation coefficient 
#methods for quantifying agreement between binary classification (from GiniClust2 paper) (values from -1 to +1)
#preds <- c(1,1,1,0,1,1,0,0)
#actuals <- c(1,1,1,1,0,0,0,0)

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(sc@cpart)

ciara_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score=rep(0,length(colnames(norm_elmir_5_30)))
result_method=rep(0,length(levels(factor(Final_Clusters))))

original_score[colnames(norm_elmir_5_30)%in%positive_cells]=1
ciara_score[final_cluster_version_sub=="PGC"]=1

for (i in 1:length(levels(factor(Final_Clusters)))){
  
  method_score=rep(0,length(colnames(norm_elmir_5_30)))
  method_score[Final_Clusters==levels(factor(Final_Clusters))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))

#with FiRE

mcc(original_score, ciara_score)
```

## singleCellHaystack

# Standard parameter

```{r}
elmir_seurat_5=cluster_analysis_integrate_rare(raw_elmir_5_30,"Elmir_data",0.1,5,30)
norm_elmir_5_30=as.matrix(GetAssayData(elmir_seurat_5, slot = "data",assay="RNA"))
norm_elmir=norm_elmir_5_30

```


```{r}
library(singleCellHaystack)
set.seed(123)
dat.pca=as.data.frame(Embeddings(elmir_seurat_5, reduction = "pca"))
median.per.gene <- apply(norm_elmir_5_30,1,median) # get the median read count per gene
dat.detection <- norm_elmir_5_30 > median.per.gene
res.pc30 <- haystack(x = dat.pca, detection = dat.detection , method = "highD")


show_result_haystack(res.haystack = res.pc30, n = 5)


top_values=row.names(res.pc30$results)[order(res.pc30$results$log.p.adj,decreasing = F)]
# plotting detection of Trim10
cordinate_umap=coordinate_umap_human
plot_gene_haystack(x = cordinate_umap, gene = top_values[1], expression = dat.detection)
plot_gene_haystack(x = cordinate_umap, gene = top_values[2], expression = dat.detection)
plot_gene_haystack(x = cordinate_umap, gene = top_values[3], expression = dat.detection)
plot_gene_haystack(x = cordinate_umap, gene = top_values[4], expression = dat.detection)

```



```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load(file="markers_first_elmir_final.Rda")
marker_elmir_all=markers_first_elmir_final[[3]]
```

```{r }
genes_important=Get_background(norm_elmir,6,0.5)
```
```{r}
Test_Fisher=function(entropy_cluster,markers_cluster,marker_top,background){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
set_1=marker_top
for (i in 1:length(level)){
  set_2=markers_cluster[names(markers_cluster)==level[i]]
set_all=background
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}
```

```{r}

load("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data/final_cluster_version_sub.Rda")
test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,top_values[1:1000],genes_important)

```

```{r}
test[[2]][test[[1]]<0.05&test[[2]]>2]
```

```{r}
marker_pgc=c("NANOS3","NANOG","SOX17","DPPA5")
(marker_pgc%in%top_values)

match(marker_pgc,top_values)


grep("NANOS3",top_values)
which(top_values=="NANOG")
grep("SOX17",top_values)
which(top_values=="DPPA5")

#which(top_values%in%top_endo)
#which(top_values%in%top_hemo)
```
##Only top 4 pgc marker
```{r}

marker_pgc=c("NANOS3","NANOG","SOX17","DPPA5")

index_sc=match(marker_pgc,top_values)
index_ciara=match(marker_pgc,geni_top_top)
index_triku=match(marker_pgc,final_sort_triku)
#index_triku_old=match(marker_pgc,final_sort_triku)
index_sam=match(marker_pgc,sam_genes)


index_dist=data.frame(index_ciara,index_sc,index_triku,index_sam)
index_dist=index_dist[order(index_ciara),]
index_dist_log=log(index_dist)
row.names(index_dist)=marker_pgc[order(index_ciara)]
colnames(index_dist)=c("CIARA","sCH","Triku","SAM")
index_dist=as.matrix(index_dist)
my_palette <- colorRampPalette(c("lightblue1", "black"))(n = 1000)
#my_palette <- colorRampPalette(c("", "#3182bd"))(n = 1000)
pdf("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/figures_paper/figures_conference/heatmap_rank_4_pgc.pdf",width=8,height = 6)
#heatmap.2(log(index_dist), scale = "none",col = bluered(100), 
          #trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1)

heatmap.2(log(index_dist), scale = "none",col = my_palette, 
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1)

dev.off()
```

## All pgc marker
```{r}
marker_pgc_full=marker_elmir_all[names(marker_elmir_all)=="PGC"]
#marker_pgc_full=marker_pgc_full[marker_pgc_full%in%geni_top_top]
common_set=Reduce(intersect,list(geni_top_top,top_values,final_sort_triku,sam_genes))
marker_pgc_full=marker_pgc_full[marker_pgc_full%in%common_set]
index_sc=match(marker_pgc_full,top_values)
index_ciara=match(marker_pgc_full,geni_top_top)
index_triku=match(marker_pgc_full,final_sort_triku)
index_sam=match(marker_pgc_full,sam_genes)

index_dist=data.frame(index_ciara,index_sc,index_triku, index_sam)
row.names(index_dist)=marker_pgc_full
index_dist=index_dist[order(index_ciara),]
colnames(index_dist)=c("CIARA","sCH","Triku","SAM")
index_dist=as.matrix(index_dist)
```

```{r}
library(gplots)
index_dist_log=log(index_dist)
heatmap.2(index_dist_log, scale = "none", col = bluered(100), 
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1,labRow=FALSE)

pdf("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/figures_paper/figures_conference/heatmap_rank_all_pgc.pdf",width=8,height = 6)
#heatmap.2(index_dist_log, scale = "none", col = bluered(100), 
          #trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1)
my_palette <- colorRampPalette(c("lightblue1", "black"))(n = 1000)
heatmap.2(index_dist_log, scale = "none", col = my_palette, trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1,labRow=FALSE)
dev.off()

#heatmap.2(index_dist, scale = "none", 
          #trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,cellnote=index_dist)


```


```{r}
breaks = seq(0,max(index_dist_log),length.out=1000)
gradient1 = colorpanel( sum( breaks[-1]<= as.vector(quantile(breaks))[2]), "#FEFEA6","#FBBA1F")
gradient2 = colorpanel( sum(breaks[-1]> as.vector(quantile(breaks))[2] & breaks[-1]<= as.vector(quantile(breaks))[3] ), "#FBBA1F", "#AB224B" )
gradient3 = colorpanel( sum( breaks[-1]> as.vector(quantile(breaks))[3] & breaks[-1]<= as.vector(quantile(breaks))[4] ), "#AB224B", "#54136E" )
gradient4 = colorpanel( sum( breaks[-1] > as.vector(quantile(breaks))[4] ), "#54136E", "#000000" )


hm.colors = c(gradient1,gradient2,gradient3,gradient4)




#pdf("/Users/gabriele.lubatti/Desktop/Phd/Early_embryonic_like_cells/Mouse/10x_data/Figures_paper/heatmap/mouse_esc.pdf")
heatmap.2(index_dist_log, scale = "none",col=hm.colors,
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,notecex=2,notecol="black",Rowv=FALSE,Colv=FALSE,labRow=FALSE)



hm.colors = c(gradient1,gradient2,gradient3,rep("#000000",length(gradient4)))


#pdf("/Users/gabriele.lubatti/Desktop/Phd/Early_embryonic_like_cells/Mouse/10x_data/Figures_paper/heatmap/mouse_esc.pdf")
heatmap.2(index_dist_log, scale = "none",col=hm.colors,
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,notecex=2,notecol="black",Rowv=FALSE,Colv=FALSE,labRow=FALSE)
#dev.off()

#pdf("/Users/gabriele.lubatti/Desktop/Phd/Early_embryonic_like_cells/Mouse/10x_data/Figures_paper/heatmap/mouse_esc_new.pdf",height = 4.6, width = 6.1)
#heatmap.2(dist_mouse, scale = "none",col=hm.colors,
          #trace = "none", density.info = "none",cexRow = 1,cexCol = 1,cellnote=labs,notecex=2,notecol="black")
#dev.off()
```


```{r}
library(gplots)
heatmap.2(index_dist, scale = "none", col = bluered(100), 
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,notecex=0.1)

heatmap.2(index_dist, scale = "none", 
          trace = "none", density.info = "none",cexRow =1,cexCol = 1,notecex=0.1,Rowv=TRUE,Colv=TRUE)

#heatmap.2(index_dist, scale = "none", 
          #trace = "none", density.info = "none",cexRow = 1,cexCol = 1,Rowv=FALSE,Colv=FALSE,cellnote=index_dist)


```


## Skip for the moment
```{r}
## Option for changing color
breaks = seq(0,max(dist_mouse),length.out=1000)
gradient1 = colorpanel( sum( breaks[-1]<= as.vector(quantile(breaks))[2]), "#FEFEA6","#FBBA1F")
gradient2 = colorpanel( sum(breaks[-1]> as.vector(quantile(breaks))[2] & breaks[-1]<= as.vector(quantile(breaks))[3] ), "#FBBA1F", "#AB224B" )
gradient3 = colorpanel( sum( breaks[-1]> as.vector(quantile(breaks))[3] & breaks[-1]<= as.vector(quantile(breaks))[4] ), "#AB224B", "#54136E" )
gradient4 = colorpanel( sum( breaks[-1] > as.vector(quantile(breaks))[4] ), "#54136E", "#000000" )
hm.colors = c(gradient1,gradient2,gradient3,gradient4)


pdf("/Users/gabriele.lubatti/Desktop/Phd/Early_embryonic_like_cells/Mouse/10x_data/Figures_paper/heatmap/mouse_esc.pdf")
heatmap.2(dist_mouse, scale = "none",col=hm.colors,
          trace = "none", density.info = "none",cexRow = 1,cexCol = 1,cellnote=labs,notecex=2,notecol="black")
dev.off()


marker_elmir_all[names(marker_elmir_all)=="PGC"]

```
 




```{r}

res.top <- show_result_haystack(res.haystack = res.pc30, n = 1000)
# cluster DEGs by their expression pattern in the 2D plot
genes.top <- row.names(res.top)
res.hc <- hclust_haystack(x = cordinate_umap, genes = genes.top, detection = dat.detection)
res.hc.clusters <- cutree(res.hc, k=5)
table(res.hc.clusters)

pl <- lapply(1:5, function(cluster) {
  gene.set <- names(res.hc.clusters)[res.hc.clusters==cluster]
  plot.title <- paste0("Cluster ", cluster)
  p <- plot_gene_set_haystack(x = cordinate_umap, genes = gene.set, detection = dat.detection)
  p + ggtitle(plot.title) + theme(legend.title = element_text(size = 8))
})
pl

```

```{r }
library(UpSetR)
load(system.file("extdata", "elmir_entropy_5_30.Rda", package ="EntropyMixingR"))

listInput <- list(EntropyMixing=(entropy_genes),singleCellHaystack=genes.top)

upset(fromList(listInput), order.by = "freq")




```




```{r}


p=list()
for(i in genes.top[1:3]){
  q=Plot_gene(norm_elmir_5_30,cordinate_umap,i,paste(i,which(genes.top==i)))
  p=list(p,q)
}
p
```

##SAM application 


```{r}
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data")
load(file="markers_first_elmir_final.Rda")
marker_elmir_all=markers_first_elmir_final[[3]]
```
## Old approach SAM
```{r}
sam_genes=read.csv("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/sam_output/sorted_sam_genes.csv")
sam_genes=sam_genes$X0
```



```{r}
Test_Fisher=function(entropy_cluster,markers_cluster,marker_top){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
set_1=marker_top
for (i in 1:length(level)){
  set_2=markers_cluster[names(markers_cluster)==level[i]]
set_all=markers_cluster
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}
test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,sam_genes[1:2000])


```

```{r}
test[[2]][test[[1]]<0.05&test[[2]]>2]
```

```{r}
grep("NANOS3",sam_genes)
which(sam_genes=="NANOG")
grep("SOX17",sam_genes)
which(sam_genes=="DPPA5")


```

```{r }
setwd("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/github_january_2022/vignettes")
vedo=load("elmir.Rda")
```



```{r }
ciara_genes=row.names(result)[result[,1]<1]
geni_top_top=row.names(result)[order(as.numeric(result[,1]))]
```





```{r}
grep("NANOS3",geni_top_top)
which(geni_top_top=="NANOG")
grep("SOX17",geni_top_top)
which(geni_top_top=="DPPA5")


```
## New approach SAM
```{r}
sam_genes=read.csv("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/sam_output/sam_rank_genes_human.csv")
sam_genes=sam_genes$X0

sam_cluster=read.csv("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/published_data/sam_output/sam_clustering_human.csv")
sam_cluster=sam_cluster$louvain_clusters
```

```{r }
Get_background=function(norm_matrix,min_cells,min_counts){
genes_filter=apply(norm_matrix,1,function(x){
x=x[x>min_counts]
if (length(x)>min_cells){return(TRUE)}
else{return(FALSE)}
})
genes_important=row.names(norm_matrix)[genes_filter]
return(genes_important)}
```

```{r }
genes_important=Get_background(norm_elmir,6,0.5)
```
```{r}
Test_Fisher=function(entropy_cluster,markers_cluster,marker_top,background){
level=levels(as.factor(entropy_cluster))
p_value=rep(0,length(level))
odds_ratio=rep(0,length(level))
set_1=marker_top
for (i in 1:length(level)){
  set_2=markers_cluster[names(markers_cluster)==level[i]]
set_all=background
show=Function_fisher(set_1,set_2,set_all)

p_value[i]=as.numeric(show$p.value)
names(p_value)[i]=level[i]
odds_ratio[i]=as.numeric(show$estimate)
names(odds_ratio)[i]=level[i]
}
return(list(p_value,odds_ratio))
}
```


```{r}
load("/Users/gabriele.lubatti/Desktop/Phd/entropy_of_mixing_library/elmir_data/final_cluster_version_sub.Rda")
test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,sam_genes[1:1000],genes_important)

test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,geni_top_top[1:1000],genes_important)

```

```{r}
test[[2]][test[[1]]<0.05&test[[2]]>2]
```



```{r }
test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,sam_genes[1:1000],genes_important)

test[[2]][test[[1]]<0.05&test[[2]]>2]


```

```{r}

test=Test_Fisher(final_cluster_version_sub,marker_elmir_all,geni_top_top[1:1000],genes_important)
test[[2]][test[[1]]<0.05&test[[2]]>2]
```

```{r}
grep("NANOS3",sam_genes)
which(sam_genes=="NANOG")
grep("SOX17",sam_genes)
which(sam_genes=="DPPA5")


```
```{r}
plot_umap(cordinate_umap,sam_cluster)
```
## Start with cluster and baloon plot
```{r}
DefaultAssay(elmir_seurat_5) <- "RNA"

excluded=names(table(sam_cluster)[table(sam_cluster)<3])
index_select=!(sam_cluster%in%excluded)

#levels(Final_Clusters)=seq(1,length(unique(Final_Clusters)))

markers_first_elmir=markers_cluster_seurat(elmir_seurat_5[,index_select],sam_cluster[index_select],names(elmir_seurat_5$RNA_snn_res.0.1)[index_select],5)
```



```{r}
marker_plot_day_24_first=markers_first_elmir[[1]]

marker_plot_plot_day_24_first=markers_first_elmir[[2]]
marker_all_day_24_first=markers_first_elmir[[3]]

```

```{r }
norm_counts_small = apply(norm_elmir_5_30, 
        1, function(x) {
            y = x/sum(x)
            return(y)
        })
norm_counts_small=t(norm_counts_small)


#plot_balloon_marker_norm(norm_counts_small,Final_Clusters,marker_all_day_24_first,5,max_size=5,text_size=10)

plot_balloon_marker(norm_elmir_5_30[,index_select],sam_cluster[index_select],marker_all_day_24_first,5,max_size=3,text_size=6)


```





```{r }
library("mltools")
#mcc()
#Matthews correlation coefficient 
#methods for quantifying agreement between binary classification (from GiniClust2 paper) (values from -1 to +1)
#preds <- c(1,1,1,0,1,1,0,0)
#actuals <- c(1,1,1,1,0,0,0,0)

geni_marker=geni_pgc
positive_cells=find_positive_cells(norm_elmir_5_30,threshold=0,geni_marker)
Final_Clusters=as.vector(sam_cluster)

ciara_score=rep(0,length(colnames(norm_elmir_5_30)))
original_score=rep(0,length(colnames(norm_elmir_5_30)))
result_method=rep(0,length(levels(factor(Final_Clusters))))

original_score[colnames(norm_elmir_5_30)%in%positive_cells]=1
ciara_score[final_cluster_version_sub=="PGC"]=1

for (i in 1:length(levels(factor(Final_Clusters)))){
  
  method_score=rep(0,length(colnames(norm_elmir_5_30)))
  method_score[Final_Clusters==levels(factor(Final_Clusters))[i]]=1
  result_method[i]=mcc(method_score, original_score)
  print(result_method[i])
}

print(max(result_method))

#with FiRE

mcc(original_score, ciara_score)
```
```{r}
find_resolution(elmir_seurat_5,rep(0.1,1,0.1))
```
